pipeline {
    agent any
    
    environment {
        VAULT_ADDR = 'http://host.docker.internal:8200'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Code checked out from GitHub'
            }
        }
        
        stage('Test with Vault Secrets') {
            steps {
                script {
                    withVault([
                        vaultSecrets: [
                            [
                                path: 'secret/jenkins/github',
                                secretValues: [
                                    [envVar: 'GITHUB_TOKEN', vaultKey: 'token']
                                ]
                            ],
                            [
                                path: 'secret/jenkins/docker',
                                secretValues: [
                                    [envVar: 'DOCKER_USER', vaultKey: 'username'],
                                    [envVar: 'DOCKER_PASS', vaultKey: 'password']
                                ]
                            ],
                            [
                                path: 'secret/jenkins/database',
                                secretValues: [
                                    [envVar: 'DB_HOST', vaultKey: 'host'],
                                    [envVar: 'DB_USER', vaultKey: 'username'],
                                    [envVar: 'DB_PASS', vaultKey: 'password']
                                ]
                            ]
                        ]
                    ]) {
                        echo "Successfully retrieved secrets from Vault!"
                        echo "GitHub Token: ${GITHUB_TOKEN.take(10)}..."
                        echo "Docker User: ${DOCKER_USER}"
                        echo "Database Host: ${DB_HOST}"
                        echo "Database User: ${DB_USER}"
                    }
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    docker.build("jenkins-demo:${env.BUILD_NUMBER}")
                }
            }
        }
        
        stage('Cleanup Old Containers') {
            steps {
                script {
                    sh '''
                        docker ps -aq --filter "name=jenkins-demo" | xargs -r docker rm -f || true
                    '''
                }
            }
        }
        
        stage('Run Container') {
            steps {
                script {
                    sh "docker run -d -p 3000:3000 --name jenkins-demo-${env.BUILD_NUMBER} jenkins-demo:${env.BUILD_NUMBER}"
                    echo "Application running on http://localhost:3000"
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'Deployment successful with Vault-managed secrets!'
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline completed successfully with Vault integration!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
